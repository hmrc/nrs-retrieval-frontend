@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.AppConfig
@import models.AuthorisedUser
@import uk.gov.hmrc.govukfrontend.views.html.components.FormWithCSRF
@import views.html.components._
@import scala.concurrent.duration._

@this(
        layout: Layout,
        formHelper: FormWithCSRF,
        p: Paragraph,
        textInput: TextInput,
        button: components.Button,
        searchResultsPanel: SearchResultsPanel
)

@(
        searchForm: Form[SearchQuery],
        maybeUser: Option[AuthorisedUser] = None,
        maybeResults: Option[Seq[SearchResult]],
        estimatedRetrievalTime: FiniteDuration
)(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

@notableEventType = @{searchForm.get.notableEventType}

@notableEvent = @{
  appConfig.notableEvents(notableEventType)
}

@pageHeader = @{
    messages(s"search.page.dynamic.header.lbl", notableEvent.displayName)
}

@pageTitle = @{
    if (maybeResults.isDefined) s"${messages("search.page.results")} - $pageHeader" else pageHeader
}

@layout(
    pageTitle = pageTitle,
    maybePageHeader = Some(pageHeader),
    maybeUser = maybeUser,
    maybeBackButtonUrl = Some(routes.SelectorController.showSelectorPage),
    maybeBodyEndBlock = None
) {
    @p(content = Text(messages("search.page.stored.info", notableEvent.storedFrom, notableEvent.storedFor)))

    @if(notableEventType == "vat-registration") {
      <div id = "vat-registration-additional-info">
        @p(content = Text(messages("search.page.vat-registration.searchkey.detail.info")))

        <ul class="govuk-list govuk-list--bullet">
            <li>@messages("search.page.vat-registration.searchkey.detail.list.0")</li>
            <li>@messages("search.page.vat-registration.searchkey.detail.list.1")</li>
        </ul>
      </div>
    }

    @p(content = Text(messages("search.page.hint", estimatedRetrievalTime)))

    @formHelper(action = routes.SearchController.submitSearchPage(notableEventType), 'class -> "form js-form") {
        <input type="hidden" name="notableEventType" value="@{notableEventType}">

        @for((searchKey, index) <- appConfig.notableEvents(notableEventType).searchKeys.zipWithIndex){
            <input type="hidden" name="searchKeyName_@{index}" value="@{searchKey.name}">

            @textInput(messages(s"search.page.searchkey.lbl", searchKey.label), searchForm(s"searchKeyValue_$index"))
        }

        @button(name = "searchButton", content = messages("search.button.search.lbl"), inputType = "submit")
    }

    @maybeResults.fold(Html("")){ results =>
      @searchResultsPanel(searchForm, results)
    }
}
